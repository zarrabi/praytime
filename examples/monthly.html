<!DOCTYPE html>
<html>

<head>
	<title>Monthly Prayer Timetable</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="style.css">
	<script src="../src/praytime.js"></script>
</head>

<body>
	<div class="header">
		<form class="form" action="javascript:update();">
			Latitude: <input type="text" value="43" id="latitude" size="4" onchange="update();" />&nbsp;
			Longitude: <input type="text" value="-80" id="longitude" size="4" onchange="update();" />&nbsp;
			Timezone: <input type="text" value="-5" id="timezone" size="4" onchange="update();" />&nbsp;
			Method:
			<select id="method" size="1" style="font-size: 12px;" onchange="update()">
				<option value="MWL" selected="selected">Muslim World League (MWL)</option>
				<option value="ISNA">Islamic Society of North America (ISNA)</option>
				<option value="Egypt">Egyptian General Authority of Survey</option>
				<option value="Makkah">Umm al-Qura University, Makkah</option>
				<option value="Karachi">University of Islamic Sciences, Karachi</option>
				<option value="Tehran">Institute of Geophysics, University of Tehran</option>
				<option value="Jafari">Leva Research Institute, Qum</option>
			</select>
		</form>
	</div>
	<br />
	<table style="margin: 0 auto;">
		<tr>
			<td><a href="javascript:displayMonth(-1)" class="arrow">&lt;&lt;</a></td>
			<td id="table-title" class="caption"></td>
			<td><a href="javascript:displayMonth(+1)" class="arrow">&gt;&gt;</a></td>
		</tr>
	</table>

	<br />
	<table id="timetable" class="timetable">
		<tbody></tbody>
	</table>

	<div class="footer">
		Source: <a href="https://praytime.info" class="command">PrayTime.info</a> |
		Time Format: <a id="time-format" href="javascript:switchFormat(1)" title="Change clock format"
			class="command"></a>
	</div>
	<br />

	<script type="text/javascript">

		const currentDate = new Date();
		let timeFormat = 1;
		switchFormat(0);

		// display monthly timetable
		function displayMonth(offset) {
			const lat = $('latitude').value;
			const lng = $('longitude').value;
			const timeZone = $('timezone').value;
			const method = $('method').value;

			praytime.method(method);
			currentDate.setMonth(currentDate.getMonth() + 1 * offset);
			const month = currentDate.getMonth();
			const year = currentDate.getFullYear();
			const title = monthFullName(month) + ' ' + year;
			$('table-title').innerHTML = title;
			makeTable(year, month, lat, lng, timeZone);
		}

		// make monthly timetable
		function makeTable(year, month, lat, lng, timezone) {
			const items = {
				day: 'Day', fajr: 'Fajr', sunrise: 'Sunrise',
				dhuhr: 'Dhuhr', asr: 'Asr', // sunset: 'Sunset', 
				maghrib: 'Maghrib', isha: 'Isha'
			};

			const tbody = document.createElement('tbody');
			tbody.appendChild(makeTableRow(items, items, 'head-row'));

			const date = new Date(year, month, 1);
			const endDate = new Date(year, month + 1, 1);
			const format = timeFormat ? '12H' : '24h';

			praytime.location([lat, lng]).utcOffset(timezone).format(format);

			while (date < endDate) {
				const times = praytime.times(date);
				times.day = date.getDate();
				const today = new Date();
				const isToday = (date.getMonth() == today.getMonth()) && (date.getDate() == today.getDate());
				const klass = isToday ? 'today-row' : '';
				tbody.appendChild(makeTableRow(times, items, klass));
				date.setDate(date.getDate() + 1);  // next day
			}
			removeAllChild($('timetable'));
			$('timetable').appendChild(tbody);
		}

		// make a table row
		function makeTableRow(data, items, klass) {
			const row = document.createElement('tr');
			for (let i in items) {
				const cell = document.createElement('td');
				cell.innerHTML = data[i];
				cell.style.width = i == 'day' ? '2.5em' : '3.7em';
				row.appendChild(cell);
			}
			row.className = klass;
			return row;
		}

		// remove all children of a node
		function removeAllChild(node) {
			if (node == undefined || node == null)
				return;

			while (node.firstChild)
				node.removeChild(node.firstChild);
		}

		// switch time format
		function switchFormat(offset) {
			const formats = ['24-hour', '12-hour'];
			timeFormat = (timeFormat + offset) % 2;
			$('time-format').innerHTML = formats[timeFormat];
			update();
		}

		// update table
		function update() {
			displayMonth(0);
		}

		// return month full name
		function monthFullName(month) {
			const monthNames = new Array('January', 'February', 'March', 'April', 'May', 'June',
				'July', 'August', 'September', 'October', 'November', 'December');
			return monthNames[month];
		}

		function $(id) {
			return document.getElementById(id);
		}

	</script>
</body>

</html>